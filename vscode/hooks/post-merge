#!/bin/bash
# post-merge hook - Beads-First Application
# STATUS: ACTIVE - AUTO-IMPORT

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
LOG_SCRIPT="$PROJECT_ROOT/scripts/beads-log-event.sh"

# Log hook trigger
if [ -x "$LOG_SCRIPT" ]; then
    "$LOG_SCRIPT" "hk.post-merge" "none" "post-merge hook triggered"
fi

echo "post-merge: Auto-importing beads state..."

# AUTO-IMPORT: Sync beads after merge (imports remote changes)
if command -v bd &> /dev/null; then
    if bd sync --quiet 2>/dev/null; then
        if [ -x "$LOG_SCRIPT" ]; then
            "$LOG_SCRIPT" "bd.sync.complete" "none" "auto-import after merge"
        fi
        echo "post-merge: Beads state updated"
    fi
fi

# CONFLICT DETECTION: Check for beads merge conflicts
if [ -f ".beads/issues.jsonl.orig" ] || [ -f ".beads/issues.jsonl.rej" ]; then
    echo ""
    echo "WARNING: Beads merge conflict detected!"
    echo ""
    echo "Conflict markers found in beads files."
    echo "Manual resolution required:"
    echo "  1. Resolve conflicts in .beads/issues.jsonl"
    echo "  2. Run: bd import -i .beads/issues.jsonl"
    echo "  3. Run: bd sync"
    echo ""
    if [ -x "$LOG_SCRIPT" ]; then
        "$LOG_SCRIPT" "bd.sync.conflict" "none" "merge conflict in beads"
    fi
fi

exit 0
