#!/bin/bash
# post-commit hook - Beads-First Application
# STATUS: ACTIVE - AUTO-SYNC

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
LOG_SCRIPT="$PROJECT_ROOT/scripts/beads-log-event.sh"

# Get the commit hash
COMMIT_HASH=$(git rev-parse HEAD 2>/dev/null || echo "unknown")
COMMIT_MSG=$(git log -1 --pretty=%B 2>/dev/null || echo "unknown")

# Log hook trigger
if [ -x "$LOG_SCRIPT" ]; then
    "$LOG_SCRIPT" "hk.post-commit" "$COMMIT_HASH" "$(echo "$COMMIT_MSG" | head -1)"
fi

echo "post-commit: Auto-syncing beads..."

# AUTO-SYNC: Sync beads after commit
if command -v bd &> /dev/null; then
    if bd sync --quiet 2>/dev/null; then
        if [ -x "$LOG_SCRIPT" ]; then
            "$LOG_SCRIPT" "bd.sync.complete" "none" "auto-sync after commit"
        fi
    fi
fi

# ISSUE LINKING: Extract issue ID from commit message
if [[ $COMMIT_MSG =~ bd-([a-z0-9]+) ]]; then
    ISSUE_ID="bd-${BASH_REMATCH[1]}"
    if [ -x "$LOG_SCRIPT" ]; then
        "$LOG_SCRIPT" "gt.commit.issue" "$ISSUE_ID" "commit $COMMIT_HASH"
    fi
    echo "post-commit: Linked to $ISSUE_ID"
fi

exit 0
