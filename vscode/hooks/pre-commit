#!/bin/bash
# pre-commit hook - Beads-First Application
# STATUS: ACTIVE - ENFORCING WORKFLOW

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
LOG_SCRIPT="$PROJECT_ROOT/scripts/beads-log-event.sh"

# Log hook trigger
if [ -x "$LOG_SCRIPT" ]; then
    "$LOG_SCRIPT" "hk.pre-commit.start" "none" "pre-commit hook triggered"
fi

echo "═══════════════════════════════════════════════════════════════"
echo "HOOK: pre-commit (ENFORCING)"
echo "═══════════════════════════════════════════════════════════════"

# ENFORCEMENT: Check if session was started with bootup skill
if [ ! -f ".beads/.session-active" ]; then
    echo "ERROR: No active beads session detected"
    echo ""
    echo "REQUIRED: Load beads-bootup skill before committing"
    echo ""
    echo "In VS Code:"
    echo "  1. Open chat (Ctrl+Shift+B or manually)"
    echo "  2. Type: 'Load beads-bootup skill'"
    echo "  3. Execute the bootup commands"
    echo "  4. Try commit again"
    echo ""
    if [ -x "$LOG_SCRIPT" ]; then
        "$LOG_SCRIPT" "hk.pre-commit.fail" "none" "no session marker"
    fi
    exit 1
fi

# ENFORCEMENT: Check if beads are healthy
if command -v bd &> /dev/null; then
    if ! bd doctor --quiet 2>/dev/null; then
        echo "ERROR: beads doctor checks failed"
        echo ""
        echo "Run: bd doctor"
        echo "Fix reported issues, then try again"
        echo ""
        if [ -x "$LOG_SCRIPT" ]; then
            "$LOG_SCRIPT" "hk.pre-commit.fail" "none" "doctor failed"
        fi
        exit 1
    fi
fi

echo "✓ Session active"
echo "✓ Beads healthy"
echo ""

# Log pass
if [ -x "$LOG_SCRIPT" ]; then
    "$LOG_SCRIPT" "hk.pre-commit.pass" "none" "checks passed"
fi

exit 0
