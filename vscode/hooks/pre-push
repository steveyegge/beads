#!/bin/bash
# pre-push hook - Beads-First Application
# STATUS: ACTIVE - ENFORCING WORKFLOW

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
LOG_SCRIPT="$PROJECT_ROOT/scripts/beads-log-event.sh"

# Log hook trigger
if [ -x "$LOG_SCRIPT" ]; then
    "$LOG_SCRIPT" "hk.pre-push.start" "none" "pre-push hook triggered"
fi

echo "═══════════════════════════════════════════════════════════════"
echo "HOOK: pre-push (ENFORCING)"
echo "═══════════════════════════════════════════════════════════════"

# ENFORCEMENT: Check if landing ritual was completed
if [ ! -f ".beads/.landing-complete" ]; then
    echo "ERROR: Landing ritual not completed"
    echo ""
    echo "REQUIRED: Load beads-landing skill before pushing"
    echo ""
    echo "In VS Code:"
    echo "  1. Open chat (Ctrl+Shift+L or manually)"
    echo "  2. Type: 'Load beads-landing skill'"
    echo "  3. Complete landing checklist"
    echo "  4. Try push again"
    echo ""
    if [ -x "$LOG_SCRIPT" ]; then
        "$LOG_SCRIPT" "hk.pre-push.fail" "none" "no landing marker"
    fi
    exit 1
fi

# ENFORCEMENT: Check if tests passed (bd-uo2u)
MARKER_CONTENT=$(cat ".beads/.landing-complete")
if echo "$MARKER_CONTENT" | grep -q "^FAILED:"; then
    echo "ERROR: Landing ritual completed but tests FAILED"
    echo ""
    echo "Push blocked because the landing marker indicates test failure."
    echo ""
    echo "To proceed:"
    echo "  1. Fix failing tests"
    echo "  2. Re-run landing ritual (tests must pass)"
    echo "  3. Try push again"
    echo ""
    if [ -x "$LOG_SCRIPT" ]; then
        "$LOG_SCRIPT" "hk.pre-push.fail" "none" "tests failed"
    fi
    exit 1
fi

# ENFORCEMENT: Check if beads are synced (no uncommitted changes in .beads/)
if ! git diff --quiet .beads/ 2>/dev/null; then
    echo "ERROR: Uncommitted changes in .beads/"
    echo ""
    echo "REQUIRED: Sync and commit beads changes"
    echo ""
    echo "Run:"
    echo "  bd sync"
    echo "  git add .beads/"
    echo "  git commit -m 'Update beads state'"
    echo "  git push"
    echo ""
    if [ -x "$LOG_SCRIPT" ]; then
        "$LOG_SCRIPT" "hk.pre-push.fail" "none" "beads not synced"
    fi
    exit 1
fi

echo "✓ Landing complete"
echo "✓ Beads synced"
echo ""

# Success! Clean up session markers to end session
rm -f .beads/.session-active .beads/.landing-complete

# Log pass
if [ -x "$LOG_SCRIPT" ]; then
    "$LOG_SCRIPT" "hk.pre-push.pass" "none" "checks passed, session ended"
fi

exit 0
