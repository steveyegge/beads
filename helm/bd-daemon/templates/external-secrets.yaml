{{- if and .Values.externalSecrets.enabled .Values.externalSecrets.doltRootPassword.remoteRef }}
# Dolt root password from secret store
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "bd-daemon.dolt.fullname" . }}-root-password
  labels:
    {{- include "bd-daemon.dolt.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: {{ .Values.externalSecrets.secretStoreKind | default "ClusterSecretStore" }}
    name: {{ .Values.externalSecrets.secretStoreName }}
  target:
    name: {{ include "bd-daemon.dolt.fullname" . }}-root-password
    creationPolicy: Owner
    template:
      type: Opaque
      metadata: {}
      data:
        password: '{{`{{ .password }}`}}'
  data:
    - secretKey: password
      remoteRef:
        key: {{ .Values.externalSecrets.doltRootPassword.remoteRef | quote }}
        {{- if .Values.externalSecrets.doltRootPassword.property }}
        property: {{ .Values.externalSecrets.doltRootPassword.property | quote }}
        {{- end }}
{{- end }}
{{- if and .Values.externalSecrets.enabled .Values.externalSecrets.doltS3Credentials.enabled .Values.externalSecrets.doltS3Credentials.remoteRef }}
---
# S3 credentials from secret store
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "bd-daemon.dolt.fullname" . }}-s3-credentials
  labels:
    {{- include "bd-daemon.dolt.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: {{ .Values.externalSecrets.secretStoreKind | default "ClusterSecretStore" }}
    name: {{ .Values.externalSecrets.secretStoreName }}
  target:
    name: {{ .Values.dolt.s3.credentials.secretName }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata: {}
      data:
        access-key: '{{`{{ .accessKey }}`}}'
        secret-key: '{{`{{ .secretKey }}`}}'
  data:
    - secretKey: accessKey
      remoteRef:
        key: {{ .Values.externalSecrets.doltS3Credentials.remoteRef | quote }}
        property: {{ .Values.externalSecrets.doltS3Credentials.accessKeyIdProperty | default "aws_access_key_id" | quote }}
    - secretKey: secretKey
      remoteRef:
        key: {{ .Values.externalSecrets.doltS3Credentials.remoteRef | quote }}
        property: {{ .Values.externalSecrets.doltS3Credentials.secretAccessKeyProperty | default "aws_secret_access_key" | quote }}
{{- end }}
{{- if and .Values.externalSecrets.enabled .Values.externalSecrets.daemonToken.remoteRef }}
---
# BD daemon authentication token from secret store
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "bd-daemon.daemon.tokenSecretName" . }}
  labels:
    {{- include "bd-daemon.daemon.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: {{ .Values.externalSecrets.secretStoreKind | default "ClusterSecretStore" }}
    name: {{ .Values.externalSecrets.secretStoreName }}
  target:
    name: {{ include "bd-daemon.daemon.tokenSecretName" . }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata: {}
      data:
        token: '{{`{{ .token }}`}}'
  data:
    - secretKey: token
      remoteRef:
        key: {{ .Values.externalSecrets.daemonToken.remoteRef | quote }}
        {{- if .Values.externalSecrets.daemonToken.property }}
        property: {{ .Values.externalSecrets.daemonToken.property | quote }}
        {{- end }}
{{- end }}
{{- if and .Values.externalSecrets.enabled .Values.externalSecrets.slackBotCredentials.enabled .Values.externalSecrets.slackBotCredentials.remoteRef }}
---
# Slack bot credentials from secret store
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Values.slackBot.secretName | default "slack-bot-credentials" }}
  labels:
    {{- include "bd-daemon.daemon.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval }}
  secretStoreRef:
    kind: {{ .Values.externalSecrets.secretStoreKind | default "ClusterSecretStore" }}
    name: {{ .Values.externalSecrets.secretStoreName }}
  target:
    name: {{ .Values.slackBot.secretName | default "slack-bot-credentials" }}
    creationPolicy: Owner
    template:
      type: Opaque
      metadata: {}
      data:
        bot-token: '{{`{{ .botToken }}`}}'
        app-token: '{{`{{ .appToken }}`}}'
  data:
    - secretKey: botToken
      remoteRef:
        key: {{ .Values.externalSecrets.slackBotCredentials.remoteRef | quote }}
        property: {{ .Values.externalSecrets.slackBotCredentials.botTokenProperty | default "bot-token" | quote }}
    - secretKey: appToken
      remoteRef:
        key: {{ .Values.externalSecrets.slackBotCredentials.remoteRef | quote }}
        property: {{ .Values.externalSecrets.slackBotCredentials.appTokenProperty | default "app-token" | quote }}
{{- end }}
