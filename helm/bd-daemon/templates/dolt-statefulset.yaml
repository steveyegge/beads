{{- if .Values.dolt.statefulSet.enabled }}
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "bd-daemon.dolt.fullname" . }}
  labels:
    {{- include "bd-daemon.dolt.labels" . | nindent 4 }}
spec:
  serviceName: {{ include "bd-daemon.dolt.fullname" . }}
  replicas: 1
  selector:
    matchLabels:
      {{- include "bd-daemon.dolt.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "bd-daemon.dolt.selectorLabels" . | nindent 8 }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/dolt-configmap.yaml") . | sha256sum }}
    spec:
      serviceAccountName: {{ include "bd-daemon.dolt.serviceAccountName" . }}
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.dolt.podSecurityContext | nindent 8 }}
      terminationGracePeriodSeconds: {{ .Values.dolt.terminationGracePeriodSeconds | default 120 }}
      {{- if and .Values.dolt.s3.enabled .Values.dolt.s3.sync.pullOnStartup }}
      initContainers:
        - name: s3-pull
          image: "{{ .Values.dolt.image.repository }}:{{ .Values.dolt.image.tag }}"
          imagePullPolicy: {{ .Values.dolt.image.pullPolicy }}
          securityContext:
            {{- toYaml .Values.dolt.securityContext | nindent 12 }}
          env:
            - name: HOME
              value: {{ include "bd-daemon.dolt.dataDir" . }}
            - name: DOLT_ROOT_PATH
              value: {{ include "bd-daemon.dolt.dataDir" . }}
            - name: AWS_REGION
              value: {{ .Values.dolt.s3.region | quote }}
            {{- if .Values.externalSecrets.enabled }}
            - name: DOLT_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "bd-daemon.dolt.fullname" . }}-root-password
                  key: password
            {{- end }}
            {{- if .Values.dolt.s3.credentials.enabled }}
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.dolt.s3.credentials.secretName }}
                  key: access-key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.dolt.s3.credentials.secretName }}
                  key: secret-key
            {{- end }}
          command:
            - /bin/sh
            - -c
            - |
              set -e
              DATA_DIR="{{ include "bd-daemon.dolt.dataDir" . }}"
              DB_DIR="{{ include "bd-daemon.dolt.databaseDir" . }}"
              REMOTE_URL="{{ include "bd-daemon.dolt.s3RemoteUrl" . }}"

              echo "Initializing Dolt data directory..."
              mkdir -p "$DATA_DIR"
              cd "$DATA_DIR"

              # Configure dolt user if not already done
              if [ ! -f "$DATA_DIR/.dolt/config_global.json" ]; then
                dolt config --global --add user.email "dolt@{{ .Release.Namespace }}.local"
                dolt config --global --add user.name "Dolt Server"
              fi

              # Check if database already exists locally
              if [ -d "$DB_DIR/.dolt" ]; then
                echo "Database exists on PVC, ensuring root@% user..."
                cd "$DB_DIR"
                # Remove DB-level .doltcfg to avoid conflicts â€” server reads from $DATA_DIR/.doltcfg
                rm -rf "$DB_DIR/.doltcfg"
                mkdir -p "$DATA_DIR/.doltcfg"
                {{- if .Values.externalSecrets.enabled }}
                if [ -n "$DOLT_ROOT_PASSWORD" ]; then
                  dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "DROP USER IF EXISTS 'root'@'%';" 2>/dev/null || true
                  dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "CREATE USER 'root'@'%' IDENTIFIED BY '$DOLT_ROOT_PASSWORD'; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
                  echo "Ensured root@% user with password from secret"
                fi
                {{- else }}
                dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "CREATE USER IF NOT EXISTS 'root'@'%'; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;" 2>/dev/null || true
                {{- end }}
              else
                echo "No local database found, attempting to clone from S3..."
                if dolt clone "$REMOTE_URL" "$DB_DIR" 2>/dev/null; then
                  echo "Successfully cloned database from S3"
                  cd "$DB_DIR"
                  rm -rf "$DB_DIR/.doltcfg"
                  mkdir -p "$DATA_DIR/.doltcfg"
                  {{- if .Values.externalSecrets.enabled }}
                  if [ -n "$DOLT_ROOT_PASSWORD" ]; then
                    dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "DROP USER IF EXISTS 'root'@'%';" 2>/dev/null || true
                    dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "CREATE USER 'root'@'%' IDENTIFIED BY '$DOLT_ROOT_PASSWORD'; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
                  else
                    dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "CREATE USER IF NOT EXISTS 'root'@'%'; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;" 2>/dev/null || true
                  fi
                  {{- else }}
                  dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "CREATE USER IF NOT EXISTS 'root'@'%'; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;" 2>/dev/null || true
                  {{- end }}
                else
                  echo "No existing data in S3, initializing new database..."
                  mkdir -p "$DB_DIR"
                  cd "$DB_DIR"
                  dolt init
                  mkdir -p "$DATA_DIR/.doltcfg"
                  {{- if .Values.externalSecrets.enabled }}
                  if [ -n "$DOLT_ROOT_PASSWORD" ]; then
                    dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "CREATE USER 'root'@'%' IDENTIFIED BY '$DOLT_ROOT_PASSWORD'; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
                  else
                    dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "CREATE USER IF NOT EXISTS 'root'@'%'; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
                  fi
                  {{- else }}
                  dolt --doltcfg-dir="$DATA_DIR/.doltcfg" sql -q "CREATE USER IF NOT EXISTS 'root'@'%'; GRANT ALL ON *.* TO 'root'@'%' WITH GRANT OPTION; FLUSH PRIVILEGES;"
                  {{- end }}
                  dolt remote add origin "$REMOTE_URL" || true
                  echo "New database initialized"
                fi
              fi

              echo "S3 pull initialization complete"
          volumeMounts:
            - name: data
              mountPath: {{ include "bd-daemon.dolt.dataDir" . }}
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
      {{- end }}
      containers:
        - name: dolt
          image: "{{ .Values.dolt.image.repository }}:{{ .Values.dolt.image.tag }}"
          imagePullPolicy: {{ .Values.dolt.image.pullPolicy }}
          securityContext:
            {{- toYaml .Values.dolt.securityContext | nindent 12 }}
          ports:
            - name: mysql
              containerPort: {{ .Values.dolt.config.port }}
              protocol: TCP
          env:
            - name: HOME
              value: {{ include "bd-daemon.dolt.dataDir" . }}
            - name: DOLT_ROOT_PATH
              value: {{ include "bd-daemon.dolt.dataDir" . }}
            - name: DOLT_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "bd-daemon.dolt.fullname" . }}-root-password
                  key: password
            - name: AWS_REGION
              value: {{ .Values.dolt.s3.region | quote }}
            {{- if .Values.dolt.s3.credentials.enabled }}
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.dolt.s3.credentials.secretName }}
                  key: access-key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.dolt.s3.credentials.secretName }}
                  key: secret-key
            {{- end }}
          command:
            - dolt
            - sql-server
          args:
            - --host=0.0.0.0
            - --port={{ .Values.dolt.config.port }}
            - --config=/etc/dolt/config.yaml
          volumeMounts:
            - name: data
              mountPath: {{ include "bd-daemon.dolt.dataDir" . }}
            - name: config
              mountPath: /etc/dolt
              readOnly: true
            {{- if .Values.dolt.initSql }}
            - name: init-sql
              mountPath: /docker-entrypoint-initdb.d
              readOnly: true
            {{- end }}
          {{- if .Values.dolt.livenessProbe.enabled }}
          livenessProbe:
            tcpSocket:
              port: {{ .Values.dolt.config.port }}
            initialDelaySeconds: {{ .Values.dolt.livenessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.dolt.livenessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.dolt.livenessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.dolt.livenessProbe.failureThreshold }}
          {{- end }}
          {{- if .Values.dolt.readinessProbe.enabled }}
          readinessProbe:
            tcpSocket:
              port: {{ .Values.dolt.config.port }}
            initialDelaySeconds: {{ .Values.dolt.readinessProbe.initialDelaySeconds }}
            periodSeconds: {{ .Values.dolt.readinessProbe.periodSeconds }}
            timeoutSeconds: {{ .Values.dolt.readinessProbe.timeoutSeconds }}
            failureThreshold: {{ .Values.dolt.readinessProbe.failureThreshold }}
          {{- end }}
          {{- if and .Values.dolt.s3.enabled .Values.dolt.s3.sync.pushOnShutdown }}
          lifecycle:
            preStop:
              exec:
                command:
                  - /bin/sh
                  - -c
                  - |
                    set -e
                    DB_DIR="{{ include "bd-daemon.dolt.databaseDir" . }}"
                    echo "Graceful shutdown: committing and pushing to S3..."
                    cd "$DB_DIR"
                    if dolt status | grep -q "modified\|new file\|deleted"; then
                      dolt add .
                      dolt commit -m "Auto-commit on pod shutdown at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
                      echo "Changes committed"
                    else
                      echo "No uncommitted changes"
                    fi
                    if dolt remote -v 2>/dev/null | grep -q origin; then
                      dolt push origin main || echo "Push failed, data may be lost"
                    else
                      echo "Warning: No remote configured, skipping push"
                    fi
                    echo "S3 push complete"
          {{- end }}
          resources:
            {{- toYaml .Values.dolt.resources | nindent 12 }}
        {{- if and .Values.dolt.s3.enabled .Values.dolt.s3.sync.schedule.enabled }}
        - name: s3-sync
          image: "{{ .Values.dolt.image.repository }}:{{ .Values.dolt.image.tag }}"
          imagePullPolicy: {{ .Values.dolt.image.pullPolicy }}
          securityContext:
            {{- toYaml .Values.dolt.securityContext | nindent 12 }}
          command:
            - /bin/sh
            - -c
            - |
              INTERVAL={{ mul .Values.dolt.s3.sync.schedule.intervalMinutes 60 }}
              GC_EVERY={{ .Values.dolt.s3.sync.schedule.gcEveryNCycles | default 12 }}
              SQUASH_EVERY={{ .Values.dolt.s3.sync.schedule.squashEveryNCycles | default 48 }}
              SQUASH_THRESHOLD={{ .Values.dolt.s3.sync.schedule.squashThreshold | default 100 }}
              DB_DIR="{{ include "bd-daemon.dolt.databaseDir" . }}"
              CYCLE=0
              FORCE_PUSH=0
              echo "Starting S3 sync sidecar (interval: ${INTERVAL}s, gc every ${GC_EVERY} cycles, squash every ${SQUASH_EVERY} cycles when >${SQUASH_THRESHOLD} commits)"
              while true; do
                sleep $INTERVAL
                CYCLE=$((CYCLE + 1))
                echo "Running scheduled S3 sync (cycle $CYCLE)..."
                cd "$DB_DIR"

                # --- Periodic squash: collapse commit history ---
                if [ $((CYCLE % SQUASH_EVERY)) -eq 0 ]; then
                  COMMIT_COUNT=$(dolt log --oneline | wc -l | tr -d ' ')
                  if [ "$COMMIT_COUNT" -gt "$SQUASH_THRESHOLD" ]; then
                    echo "Squashing $COMMIT_COUNT commits (threshold: $SQUASH_THRESHOLD)..."
                    # Commit any uncommitted changes first
                    if dolt status | grep -q "modified\|new file\|deleted"; then
                      dolt add .
                      dolt commit -m "Pre-squash commit at $(date -u +%Y-%m-%dT%H:%M:%SZ)" || true
                    fi
                    # Backup current branch before squash
                    BACKUP_BRANCH="backup/pre-squash-$(date -u +%Y%m%dT%H%M%SZ)"
                    dolt branch "$BACKUP_BRANCH" 2>&1 && echo "Created backup branch: $BACKUP_BRANCH" || echo "Warning: backup branch creation failed"
                    if dolt remote -v 2>/dev/null | grep -q origin; then
                      dolt push origin "$BACKUP_BRANCH" 2>&1 && echo "Pushed backup branch to S3" || echo "Warning: backup branch push failed"
                    fi
                    # Strip ANSI color codes from dolt log output
                    ROOT=$(dolt log --oneline | tail -1 | sed 's/\x1b\[[0-9;]*m//g' | awk '{print $1}')
                    if [ -n "$ROOT" ]; then
                      if dolt reset --soft "$ROOT" 2>&1 && \
                         dolt add . && \
                         dolt commit -m "Squashed: auto-maintenance ($COMMIT_COUNT commits) at $(date -u +%Y-%m-%dT%H:%M:%SZ)"; then
                        echo "Squash complete: $COMMIT_COUNT -> 2 commits"
                        FORCE_PUSH=1
                      else
                        echo "Squash failed, continuing with normal sync"
                      fi
                    fi
                    # Always GC after squash
                    echo "Running dolt gc after squash..."
                    dolt gc --shallow 2>&1 || echo "GC after squash failed"
                  else
                    echo "Squash skipped: only $COMMIT_COUNT commits (threshold: $SQUASH_THRESHOLD)"
                  fi
                fi

                # --- Normal sync: commit + push ---
                if dolt status | grep -q "modified\|new file\|deleted"; then
                  echo "Uncommitted changes detected, committing..."
                  dolt add .
                  dolt commit -m "Auto-commit at $(date -u +%Y-%m-%dT%H:%M:%SZ)"
                  echo "Changes committed, pushing to S3..."
                  if dolt remote -v 2>/dev/null | grep -q origin; then
                    if [ "$FORCE_PUSH" -eq 1 ]; then
                      echo "Force pushing after squash..."
                      dolt push --force origin main || echo "Force push failed"
                      FORCE_PUSH=0
                    else
                      dolt push origin main || echo "Push failed"
                    fi
                  else
                    echo "Warning: No remote configured, skipping push"
                  fi
                else
                  # Still need to force-push after squash even if no new changes
                  if [ "$FORCE_PUSH" -eq 1 ]; then
                    echo "Force pushing squashed history to S3..."
                    if dolt remote -v 2>/dev/null | grep -q origin; then
                      dolt push --force origin main || echo "Force push failed"
                    fi
                    FORCE_PUSH=0
                  else
                    echo "No uncommitted changes"
                  fi
                fi

                # --- Periodic GC ---
                if [ $((CYCLE % GC_EVERY)) -eq 0 ]; then
                  echo "Running scheduled dolt gc (shallow)..."
                  dolt gc --shallow 2>&1 && echo "GC complete" || echo "GC failed"
                fi
              done
          env:
            - name: HOME
              value: {{ include "bd-daemon.dolt.dataDir" . }}
            - name: DOLT_ROOT_PATH
              value: {{ include "bd-daemon.dolt.dataDir" . }}
            - name: AWS_REGION
              value: {{ .Values.dolt.s3.region | quote }}
            {{- if .Values.dolt.s3.credentials.enabled }}
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.dolt.s3.credentials.secretName }}
                  key: access-key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.dolt.s3.credentials.secretName }}
                  key: secret-key
            {{- end }}
          volumeMounts:
            - name: data
              mountPath: {{ include "bd-daemon.dolt.dataDir" . }}
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi
        {{- end }}
      volumes:
        - name: config
          configMap:
            name: {{ include "bd-daemon.dolt.fullname" . }}-config
        {{- if .Values.dolt.initSql }}
        - name: init-sql
          configMap:
            name: {{ include "bd-daemon.dolt.fullname" . }}-init-sql
        {{- end }}
      {{- with .Values.dolt.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.dolt.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.dolt.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
  {{- if .Values.dolt.persistence.enabled }}
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          {{- include "bd-daemon.dolt.selectorLabels" . | nindent 10 }}
      spec:
        accessModes:
          - {{ .Values.dolt.persistence.accessMode }}
        storageClassName: {{ .Values.dolt.persistence.storageClass }}
        resources:
          requests:
            storage: {{ .Values.dolt.persistence.size }}
  persistentVolumeClaimRetentionPolicy:
    whenDeleted: {{ if .Values.dolt.persistence.deleteClaim }}Delete{{ else }}Retain{{ end }}
    whenScaled: Retain
  {{- end }}
{{- end }}
