# gastown-ha: HA Dolt cluster for e2e validation
# Deploy with: helm upgrade --install gastown-ha ./helm/bd-daemon -n gastown-ha --values helm/bd-daemon/values/gastown-ha.yaml

image:
  repository: ghcr.io/groblegark/beads
  tag: "sha-99befd9"

daemon:
  replicaCount: 2
  deploymentStrategy: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0
  logLevel: info
  logJSON: true

  # PDB: always keep at least 1 daemon running during voluntary disruptions
  pdb:
    enabled: true
    maxUnavailable: 1

  # Spread daemon pods across nodes for HA
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: daemon
            topologyKey: kubernetes.io/hostname

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

dolt:
  statefulSet:
    enabled: true

  database: beads

  image:
    repository: 909418727440.dkr.ecr.us-east-1.amazonaws.com/external/dolthub/dolt-sql-server
    tag: "1.81.6"

  config:
    port: 3306
    log_level: info
    max_connections: 50
    read_timeout_millis: 28800000
    write_timeout_millis: 28800000

  # HA cluster: 3 replicas with standby replication
  cluster:
    enabled: true
    replicas: 3
    remotesapiPort: 50051
    bootstrapEpoch: 1
    clusterctl:
      enabled: true
      image:
        repository: 909418727440.dkr.ecr.us-east-1.amazonaws.com/external/dolthub/doltclusterctl
        tag: "latest"
      schedule: "*/1 * * * *"
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 128Mi

  # S3 disabled for initial e2e â€” test pure replication first
  s3:
    enabled: false

  # Smaller resources for e2e testing
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

  persistence:
    enabled: true
    storageClass: gp2
    accessMode: ReadWriteOnce
    size: 5Gi
    deleteClaim: true  # Clean up PVCs on delete for e2e

  terminationGracePeriodSeconds: 60

  livenessProbe:
    enabled: true
    initialDelaySeconds: 20
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3

  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

externalSecrets:
  enabled: true
  refreshInterval: "15m"
  secretStoreKind: ClusterSecretStore
  secretStoreName: "aws-secretsmanager"
  doltRootPassword:
    remoteRef: "shared-e2e-dolt-root-password"
    property: "password"
  daemonToken:
    remoteRef: "shared-e2e-bd-daemon-token"
