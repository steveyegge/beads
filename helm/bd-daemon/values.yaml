# bd-daemon Helm chart values
# All new features (Dolt StatefulSet, Slack bot, ExternalSecrets, Ingress) are
# disabled by default for backward compatibility.

# --- Daemon image ---
image:
  repository: ghcr.io/steveyegge/beads
  pullPolicy: IfNotPresent
  tag: ""  # Defaults to Chart.appVersion

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

# --- Daemon configuration ---
daemon:
  replicaCount: 1
  deploymentStrategy: Recreate

  # Rolling update params (only used when deploymentStrategy: RollingUpdate)
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

  # Token for RPC authentication
  token: ""

  # Logging
  logLevel: "info"
  logJSON: true

  # TCP RPC listener
  tcp:
    addr: ":9876"
    port: 9876

  # HTTP API listener (health checks, ingress)
  http:
    enabled: true
    addr: ":9080"
    port: 9080

  # TLS
  tls:
    enabled: false
    existingSecret: ""

  # Priority class (e.g., "production")
  priorityClassName: ""

  # Service account
  serviceAccount:
    create: true
    annotations: {}
    name: ""

  # Service
  service:
    type: ClusterIP
    port: 9876
    httpPort: 9080

  # Health probes
  startupProbe:
    enabled: true
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 30
  livenessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    enabled: true
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Pod disruption budget
  pdb:
    enabled: false
    maxUnavailable: 0

  # Resources
  resources: {}
    # limits:
    #   cpu: 2
    #   memory: 4Gi
    # requests:
    #   cpu: 500m
    #   memory: 1Gi

  # Scheduling
  nodeSelector: {}
  tolerations: []
  affinity: {}

# --- Dolt database ---
dolt:
  # Deploy Dolt as a StatefulSet within the chart
  statefulSet:
    enabled: false

  # OR connect to an external Dolt sql-server (legacy mode)
  serverMode:
    enabled: false
    host: "dolt-sql-server"
    port: 3307
    user: "root"
    database: "beads"
    # existingSecret: ""
    # existingSecretKey: "dolt-password"

  # Database name
  database: "beads"

  # Dolt image (used when statefulSet.enabled=true)
  image:
    repository: dolthub/dolt-sql-server
    tag: "1.81.6"
    pullPolicy: IfNotPresent

  # User for server config
  user:
    name: "root"

  # Dolt SQL server configuration
  config:
    host: "0.0.0.0"
    port: 3306
    log_level: info
    max_connections: 100
    read_timeout_millis: 28800000
    write_timeout_millis: 28800000

  # Service
  service:
    type: ClusterIP
    port: 3306

  # Service account
  serviceAccount:
    create: true
    annotations: {}
    name: ""

  # S3 backup/sync
  s3:
    enabled: false
    region: "us-east-1"
    bucket: ""
    prefix: ""
    dynamoTable: ""
    credentials:
      enabled: false
      secretName: "dolt-s3-credentials"
    sync:
      pullOnStartup: true
      pushOnShutdown: true
      schedule:
        enabled: false
        intervalMinutes: 60
        gcEveryNCycles: 12
        squashEveryNCycles: 48
        squashThreshold: 100

  # EKS Pod Identity for S3 access (alternative to static credentials)
  podIdentity:
    enabled: false
    clusterName: ""
    roleArn: ""

  # Persistence (PVC for StatefulSet)
  persistence:
    enabled: true
    storageClass: "gp3"
    accessMode: ReadWriteOnce
    size: 10Gi
    deleteClaim: false

  # HA cluster (standby replication)
  cluster:
    enabled: false
    replicas: 1              # Set to 3 for HA
    remotesapiPort: 50051    # Port for inter-node replication
    bootstrapEpoch: 1        # Increment on manual failover
    # doltclusterctl label controller
    clusterctl:
      enabled: true          # Deploy CronJob to apply primary/standby labels
      image:
        repository: dolthub/doltclusterctl
        tag: "latest"
        pullPolicy: IfNotPresent
      schedule: "*/1 * * * *"  # Every minute
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 100m
          memory: 128Mi

  # Init SQL script (optional)
  initSql: ""

  # Termination grace period (seconds)
  terminationGracePeriodSeconds: 120

  # Security contexts
  podSecurityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    runAsNonRoot: true
  securityContext:
    allowPrivilegeEscalation: false

  # Health probes
  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Pod disruption budget
  pdb:
    enabled: false
    maxUnavailable: 0

  # Resources
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi

  # Scheduling
  nodeSelector: {}
  tolerations: []
  affinity: {}

# --- Slack bot sidecar ---
slackBot:
  enabled: false
  image:
    repository: ""  # Defaults to main image.repository
    tag: ""         # Defaults to main image.tag
    pullPolicy: ""  # Defaults to main image.pullPolicy
  secretName: "slack-bot-credentials"
  coopBrokerURL: ""  # Coopmux URL for credential reauth (e.g. "http://gastown-next-coop-broker:9800")
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# --- External Secrets Operator ---
externalSecrets:
  enabled: false
  refreshInterval: "15m"
  secretStoreKind: ClusterSecretStore
  secretStoreName: ""  # Name of your ClusterSecretStore/SecretStore

  # Dolt root password
  doltRootPassword:
    remoteRef: ""      # Secret key in your secret store
    property: ""       # Property within the secret (if JSON)

  # S3 credentials
  doltS3Credentials:
    enabled: false
    remoteRef: ""
    accessKeyIdProperty: "aws_access_key_id"
    secretAccessKeyProperty: "aws_secret_access_key"

  # Daemon token
  daemonToken:
    remoteRef: ""
    property: ""

  # Slack bot credentials
  slackBotCredentials:
    enabled: false
    remoteRef: ""
    botTokenProperty: "bot-token"
    appTokenProperty: "app-token"

# --- Ingress (Traefik IngressRoute) ---
ingress:
  enabled: false
  host: ""
  entryPoints:
    - web
    - websecure
  ipWhitelist:
    enabled: false
    sourceRange: []
  rateLimit:
    enabled: false
    average: 50
    burst: 100

# --- Redis WispStore ---
redis:
  enabled: false

  # Key namespace prefix
  namespace: "bd"

  # TTL for wisp entries
  wispTTL: "24h"

  # Bitnami Redis subchart overrides
  architecture: standalone
  auth:
    enabled: true
    password: ""

  master:
    persistence:
      enabled: false  # Wisps are ephemeral

# --- NATS event bus ---
nats:
  enabled: false

  # Deploys a standalone NATS server (StatefulSet + Service + ConfigMap).
  # When enabled, the daemon connects as a client (BD_NATS_URL) instead
  # of starting its embedded NATS server.

  # Token auth (shared with daemon and agents).
  # Set via --set nats.auth.token=<daemon-token> at deploy time.
  # Leave empty to disable auth (cluster-internal only).
  auth:
    enabled: false
    token: ""

  # JetStream (required for HOOK_EVENTS, DECISION_EVENTS streams)
  jetstream:
    maxMemory: 256M

  # Persistence for JetStream file store
  persistence:
    enabled: true
    storageClass: ""
    size: 2Gi

  # Official NATS alpine image (tiny, no entrypoint issues)
  # Default to ECR mirror to avoid Docker Hub rate limits.
  image:
    registry: public.ecr.aws
    repository: docker/library/nats
    tag: "2.10-alpine"
    pullPolicy: IfNotPresent

  # WebSocket listener for browser-based and external NATS clients.
  # Clients connect via wss://<host>/nats when ingress is enabled.
  websocket:
    enabled: false
    port: 8443

  # Ingress for external NATS access (WebSocket + monitoring).
  # Requires websocket.enabled=true for client connections.
  # Monitoring endpoints (/nats-monitor/connz, /nats-monitor/jsz, etc.)
  # are always available when ingress is enabled.
  ingress:
    enabled: false
    host: ""
    entryPoints:
      - web
      - websecure
    stripPrefix: true  # Strip /nats prefix before forwarding to NATS WS

  # Resource limits
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

# --- Pod configuration ---
podAnnotations: {}

podSecurityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true

securityContext:
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# Additional environment variables
extraEnv: []
