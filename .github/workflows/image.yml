# Build and push OCI image via RWX native build (no Docker daemon).
# Uses .rwx/image.yml for the build, crane for multi-tag publishing.
name: Image

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]
    paths:
      - 'go.mod'
      - 'go.sum'
      - 'cmd/**'
      - 'internal/**'
      - '.rwx/image.yml'
      - '.github/workflows/image.yml'

concurrency:
  group: image-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: groblegark/beads

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v6

      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # PR builds: build only, no push (validates the image builds cleanly)
      - name: Build image (PR)
        if: github.event_name == 'pull_request'
        uses: rwx-cloud/build-push-action@v1.0.1
        with:
          access-token: ${{ secrets.RWX_ACCESS_TOKEN }}
          file: .rwx/image.yml
          target: image
          init: commit-sha=${{ github.sha }},ref-name=pr

      # Main/tag builds: build + push primary tag
      - name: Build and push image
        if: github.event_name != 'pull_request'
        id: build
        uses: rwx-cloud/build-push-action@v1.0.1
        with:
          access-token: ${{ secrets.RWX_ACCESS_TOKEN }}
          file: .rwx/image.yml
          target: image
          init: commit-sha=${{ github.sha }},ref-name=${{ github.ref }}
          push-to: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}

      # Add extra tags (latest, version) via crane
      - name: Add tags
        if: github.event_name != 'pull_request'
        run: |
          curl -sSfL https://github.com/google/go-containerregistry/releases/download/v0.20.3/go-containerregistry_Linux_x86_64.tar.gz \
            | tar xz -C /usr/local/bin crane

          SHA_TAG="sha-${GITHUB_SHA:0:7}"
          FULL_REF="${REGISTRY}/${IMAGE_NAME}:sha-${GITHUB_SHA}"

          # Short SHA tag (matches old docker.yml format)
          crane tag "${FULL_REF}" "${SHA_TAG}"

          # Latest tag
          crane tag "${FULL_REF}" latest

          # Version tag on release
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF_NAME#v}"
            crane tag "${FULL_REF}" "${VERSION}"
            echo "Tagged: ${SHA_TAG}, latest, ${VERSION}"
          else
            echo "Tagged: ${SHA_TAG}, latest"
          fi
